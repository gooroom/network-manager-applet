From 98dc7a7657b2609fcac05134db99455a9de6610a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ji=C5=99=C3=AD=20Klime=C5=A1?= <jklimes@redhat.com>
Date: Thu, 2 Apr 2015 14:06:39 +0200
Subject: applet: do not crash when ModemManager is not available (rh #1199288)
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/+bug/1418260
Last-Update: 2015-07-10

https://bugzilla.redhat.com/show_bug.cgi?id=1199288

---
 src/applet-device-broadband.c |   17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

Index: b/src/applet-device-broadband.c
===================================================================
--- a/src/applet-device-broadband.c
+++ b/src/applet-device-broadband.c
@@ -476,7 +476,15 @@ get_secrets (SecretsRequest *req,
 		return FALSE;
 
 	devinfo = g_object_get_data (G_OBJECT (device), "devinfo");
-	g_assert (devinfo);
+	if (!devinfo) {
+		g_set_error (error,
+		             NM_SECRET_AGENT_ERROR,
+		             NM_SECRET_AGENT_ERROR_INTERNAL_ERROR,
+		             "%s.%d (%s): ModemManager is not available for modem at %s",
+		             __FILE__, __LINE__, __func__,
+		             nm_device_get_udi (device));
+		return FALSE;
+	}
 
 	/* A GetSecrets PIN dialog overrides the initial unlock dialog */
 	if (devinfo->dialog)
@@ -629,7 +637,7 @@ get_icon (NMDevice *device,
 
 	if (!applet->mm1) {
 		g_warning ("ModemManager is not available for modem at %s", nm_device_get_udi (device));
-		return NULL;
+		return;
 	}
 
 	info = g_object_get_data (G_OBJECT (device), "devinfo");
@@ -712,6 +720,11 @@ add_menu_item (NMDevice *device,
 	GSList *iter;
 
 	info = g_object_get_data (G_OBJECT (device), "devinfo");
+	if (!info) {
+		g_warning ("ModemManager is not available for modem at %s",
+		           nm_device_get_udi (device));
+		return;
+	}
 
 	if (multiple_devices) {
 		const char *desc;
